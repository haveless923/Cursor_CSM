# å¿«é€Ÿä¿®å¤ Supabase ç™»å½•é—®é¢˜

## ğŸš¨ å½“å‰é—®é¢˜

ä»æ§åˆ¶å°é”™è¯¯å¯ä»¥çœ‹åˆ°ï¼š
1. RPC å‡½æ•° `verify_login` ä¸å­˜åœ¨ï¼ˆ404 é”™è¯¯ï¼‰
2. ç›´æ¥æŸ¥è¯¢ users è¡¨è¢« RLS é˜»æ­¢ï¼ˆ406 é”™è¯¯ï¼‰

## âœ… å¿«é€Ÿè§£å†³æ–¹æ¡ˆï¼ˆ3æ­¥æå®šï¼‰

### æ­¥éª¤ 1ï¼šç™»å½• Supabase Dashboard

1. è®¿é—®ï¼šhttps://supabase.com/dashboard
2. é€‰æ‹©é¡¹ç›®ï¼š`jpaurpkibrjwqthrcexc`
3. ç‚¹å‡»å·¦ä¾§èœå•çš„ **SQL Editor**

### æ­¥éª¤ 2ï¼šæ‰§è¡Œä»¥ä¸‹ SQLï¼ˆå¤åˆ¶ç²˜è´´æ‰§è¡Œï¼‰

```sql
-- ç¦ç”¨ users è¡¨çš„ RLSï¼ˆæœ€ç®€å•å¿«é€Ÿï¼‰
ALTER TABLE users DISABLE ROW LEVEL SECURITY;
```

**æˆ–è€…** å¦‚æœä½ æƒ³ä¿æŒ RLS å¯ç”¨ï¼Œä½¿ç”¨è¿™ä¸ªï¼š

```sql
-- å¯ç”¨ RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- åˆ é™¤ç°æœ‰ç­–ç•¥ï¼ˆå¦‚æœæœ‰ï¼‰
DROP POLICY IF EXISTS "Allow login query" ON users;

-- åˆ›å»ºå…è®¸æŸ¥è¯¢çš„ç­–ç•¥
CREATE POLICY "Allow login query" ON users
  FOR SELECT
  USING (true);
```

### æ­¥éª¤ 3ï¼šåˆ·æ–°é¡µé¢å¹¶æµ‹è¯•ç™»å½•

1. åˆ·æ–° Vercel ä¸Šçš„é¡µé¢
2. ä½¿ç”¨è´¦å·ï¼š`admin` / `admin123` ç™»å½•
3. åº”è¯¥å¯ä»¥æˆåŠŸç™»å½•äº†ï¼

## ğŸ” éªŒè¯æ˜¯å¦æˆåŠŸ

æ‰§è¡Œ SQL åï¼Œåœ¨æµè§ˆå™¨æ§åˆ¶å°åº”è¯¥ä¸å†çœ‹åˆ°ï¼š
- âŒ `406` é”™è¯¯
- âŒ `ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯`

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·å‘Šè¯‰æˆ‘å…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚

## ğŸ“ åç»­ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

ç™»å½•åŠŸèƒ½æ­£å¸¸åï¼Œå¯ä»¥åˆ›å»º RPC å‡½æ•°æ¥æ›´å®‰å…¨åœ°å¤„ç†ç™»å½•ï¼š

```sql
CREATE OR REPLACE FUNCTION verify_login(
  p_username TEXT,
  p_password TEXT
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_user RECORD;
  v_token TEXT;
BEGIN
  SELECT * INTO v_user
  FROM users
  WHERE username = p_username;
  
  IF NOT FOUND THEN
    RETURN json_build_object('success', false, 'error', 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
  END IF;
  
  v_token := encode(
    convert_to(
      json_build_object(
        'userId', v_user.id,
        'username', v_user.username,
        'role', v_user.role
      )::text,
      'UTF8'
    ),
    'base64'
  );
  
  RETURN json_build_object(
    'success', true,
    'user', json_build_object(
      'id', v_user.id,
      'username', v_user.username,
      'role', v_user.role
    ),
    'token', v_token
  );
END;
$$;

GRANT EXECUTE ON FUNCTION verify_login(TEXT, TEXT) TO anon;
GRANT EXECUTE ON FUNCTION verify_login(TEXT, TEXT) TO authenticated;
```

## âš ï¸ é‡è¦æç¤º

å½“å‰å®ç°ä¸ºäº†å¿«é€Ÿä¿®å¤ï¼Œ**æš‚æ—¶ä¸éªŒè¯å¯†ç **ã€‚è¿™æ„å‘³ç€åªè¦ç”¨æˆ·åå­˜åœ¨å°±èƒ½ç™»å½•ã€‚

**ç”Ÿäº§ç¯å¢ƒå¿…é¡»**ï¼š
1. ä½¿ç”¨ Edge Function éªŒè¯å¯†ç 
2. æˆ–è€…ä½¿ç”¨ Supabase Auth
3. æˆ–è€…åœ¨æœåŠ¡ç«¯éªŒè¯å¯†ç 

